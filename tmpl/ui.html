<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>rtop-viz</title>
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
	      <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
	      <style type="text/css"></style>
    </head>
    <body>
        <div id="container"></div>
  	    <div class="container-fluid">
	          <div class="row">
	              <div class="col-sm-4">
			              <h2>Load Average</h2>
		            </div>
	              <div class="col-sm-4">
			              <h2>Memory Usage</h2>
		            </div>
                <div class="col-sm-4">
			              <h2>CPU Usage</h2>
		            </div>
	          </div>
	          <div class="row">
	              <div class="col-sm-4 chartc">
		                {{range .Keys}}
		                <div id="id-{{.}}" class="chart"></div>
		                {{end}}
		            </div>
	              <div class="col-sm-4 chartc">
		                {{range .Keys}}
		                <div id="mid-{{.}}" class="chart"></div>
		                {{end}}
		            </div>
                <div class="col-sm-4 chartc">
		                {{range .Keys}}
		                <div id="cpu-{{.}}" class="chart"></div>
		                {{end}}
		            </div>
	          </div>
	      </div>

        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	      <script src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.1/dygraph-combined.js"></script>
	      <script>

        var laDictGraph = {}; // Dict. of Load Average graphs
        var memDictGraph = {}; // Dict. of Memory graphs
        var cpuDictGraph = {}; // Ditc. of CPU graphs
        var laDATA = {};
        function $(elem) {
                return document.querySelectorAll(elem);
        }
        function init(){
                var ws;

                if (window.WebSocket === undefined) {
                        console.log("Your browser does not support WebSockets");
                        return;
                } else {
                        ws = initWS();
                }

                function initWS() {
                        var socket = new WebSocket("ws://localhost:8080/ws");
                        socket.onopen = function() {

                        };
                        socket.onmessage = function (e) {
                                var data = JSON.parse(e.data)
                                data.forEach(function(elem){
                                        var hostname = elem.Hostname;
                                        if (hostname && !laDictGraph.hasOwnProperty(hostname)){
                                                laDictGraph[hostname] = printPlots(elem, hostname);
                                        }
                                        laDictGraph[hostname].updateOptions({'file': getLoadAverage(elem)});
                                });
                        };
                        socket.onclose = function () {

                        };

                        return socket;
                }

                function printPlots(data, host) {
                        var loadAverageGraph = new Dygraph(
                         document.getElementById("id-" + host),
                         getLoadAverage(data),
                         {
                             title: host,
                             axisLabelFontSize: 10,
                             axes: { y: { axisLabelWidth: 30 } },
                             labels: [ "X", "Load Average" ],
                             gridLineColor: 'rgb(200,200,200)'
                         });
                         return loadAverageGraph;
                }

                function getLoadAverage(stats) {
                        if (!laDATA[stats.Hostname]){
                            laDATA[stats.Hostname] = [];
                        }
                        laDATA[stats.Hostname].push([new Date(stats.At), stats.Load1])
                        return laDATA[stats.Hostname];
//                        var loadAverage = [];
//
//                        for (var i = 0; i < stats.length; i++) {
//                                date = new Date(stats[i].At);
//                                loadAverage.push([date, stats[i].Load1]);
//                        }
//
//                        return loadAverage;
                }

                function getMemory(stats) {
                        var memory = [];

                        for (var i = 0; i < stats.length; i++) {
                                date = new Date(stats[i].At);
                                memory.push([date,
                                          stats[i].MemCached,
                                          stats[i].MemBuffers,
                                          stats[i].MemFree,
                                          stats[i].MemUsed]);
                        }

                        return memory;
                }

                function getCPU(stats) {
                        var cpu = [];

                        for (var i = 0; i < stats.length; i++) {
                        date = new Date(stats[i].At);
                        cpu.push([date,
                               stats[i].CPU.User,
                               stats[i].CPU.Nice,
                               stats[i].CPU.System,
                               stats[i].CPU.Idle,
                               stats[i].CPU.Iowait,
                               stats[i].CPU.Irq,
                               stats[i].CPU.SoftIrq,
                               stats[i].CPU.Steal,
                               stats[i].CPU.Guest]);
                        }

                        return cpu;
                }
        }

        window.addEventListener("load", init);

        </script>
    </body>
</html>
